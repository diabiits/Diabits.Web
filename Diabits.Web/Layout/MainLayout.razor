@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject AuthService AuthService
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

@* Required *@
<MudThemeProvider Theme="@CustomTheme.DiabitsTheme" />
<MudPopoverProvider />

@* Needed for dialogs *@
<MudDialogProvider />

@* Needed for snackbars *@
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudLink Href="/" Underline="Underline.None" Class="d-flex h-100 py-2">
            <MudImage Src="assets/wordmark_white.png" Alt="Diabits wordmark" />
        </MudLink>
        <MudSpacer />
        @if (_isAdmin)
        {
            <MudIconButton Icon="@Icons.Material.Filled.AdminPanelSettings" Color="Color.Inherit" OnClick="@(() => Nav.NavigateTo("/invites"))" />
        }
        <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Inherit" OnClick="@(() => Nav.NavigateTo("/settings"))" />
        <MudIconButton Icon="@Icons.Material.Filled.Logout" Color="Color.Inherit" OnClick="LogoutAsync" />
    </MudAppBar>
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>


@code {
    private bool _isAdmin;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _isAdmin = user.IsInRole("Admin");
    }

    private async Task LogoutAsync()
    {
        await AuthService.LogoutAsync();
        Nav.NavigateTo("/login");
    }
}