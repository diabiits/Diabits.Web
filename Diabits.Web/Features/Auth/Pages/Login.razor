@page "/login"
@layout AuthLayout

@using Diabits.Web.Features.Auth.Services

@inject AuthService AuthService
@inject NavigationManager Nav

<MudPaper Elevation="0" Class="pa-6" Style="width:min(420px, 92vw); border-radius:16px; ">
    <MudStack Spacing="3">

        <MudStack Spacing="0" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h5">Sign in</MudText>
        </MudStack>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <MudAlert Severity="Severity.Error" Dense="true" Elevation="0">
                @_error
            </MudAlert>
        }

        <MudForm @ref="_form">
            <MudTextField T="string"
                          Style="background-color: #cfd6cc "
                          @bind-Value="_model.Username"
                          Label="Username"
                          Variant="Variant.Outlined"
                          Disabled="_busy"
                          Immediate="true"
                          Validation="ValidateUsername"
                          OnKeyDown="HandleKeyDown" />

            <MudTextField T="string"
                          Style="background-color: #cfd6cc"
                          @bind-Value="_model.Password"
                          Label="Password"
                          Variant="Variant.Outlined"
                          InputType="InputType.Password"
                          Disabled="_busy"
                          Immediate="true"
                          Validation="ValidatePassword"
                          OnKeyDown="HandleKeyDown" />

            <MudButton FullWidth="true"
                       Class="mt-8 pa-4"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="_busy"
                       OnClick="SubmitAsync">
                @if (_busy)
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-2" />
                    <MudText Typo="Typo.button">Signing in...</MudText>
                }
                else
                {
                    <MudText Typo="Typo.button">Sign in</MudText>
                }
            </MudButton>

            @if (_busy)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                    Contacting server...
                </MudText>
            }
        </MudForm>

    </MudStack>
</MudPaper>

@code {
    private MudForm? _form;
    private readonly LoginModel _model = new();

    private bool _busy;
    private string? _error;

    private string? ValidateUsername(string value)
        => string.IsNullOrWhiteSpace(value) ? "Username is required" : null;

    private string? ValidatePassword(string value)
        => string.IsNullOrWhiteSpace(value) ? "Password is required" : null;

    private async Task SubmitAsync()
    {
        if (_busy) return;

        _error = null;

        if (_form is null)
        {
            _error = "Login form not initialized.";
            return;
        }

        await _form.Validate();
        if (!_form.IsValid)
            return;

        _busy = true;
        try
        {
            var result = await AuthService.LoginAsync(_model.Username, _model.Password);

            if (!result.Ok)
            {
                _error = "Login failed. Check username and password.";
                return;
            }

            Nav.NavigateTo("/", replace: true);
        }
        catch
        {
            _error = "Backend unavailable. Try again.";
        }
        finally
        {
            _busy = false;
        }
    }

    private Task HandleKeyDown(KeyboardEventArgs e)
        => e.Key == "Enter" ? SubmitAsync() : Task.CompletedTask;

    private sealed class LoginModel
    {
        public string Username { get; set; } = "";
        public string Password { get; set; } = "";
    }
}
